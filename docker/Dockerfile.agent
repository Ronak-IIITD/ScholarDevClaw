FROM node:20-alpine AS builder

WORKDIR /app

RUN apk add --no-cache libc6-compat

COPY agent/package.json agent/bun.lockb* ./

RUN corepack enable && corepack prepare bun@latest --activate

RUN bun install --frozen-lockfile --production

COPY agent/ ./

RUN bun run build

FROM node:20-alpine AS production

WORKDIR /app

RUN addgroup -S -g 1001 agent \
    && adduser -S -u 1001 -G agent agent

RUN apk add --no-cache curl

COPY --from=builder --chown=agent:agent /app/node_modules ./node_modules
COPY --from=builder --chown=agent:agent /app/dist ./dist
COPY --from=builder --chown=agent:agent /app/package.json ./

RUN mkdir -p /app/data /app/logs \
    && chown -R agent:agent /app

USER agent

ENV NODE_ENV=production
ENV NODE_OPTIONS="--max-old-space-size=512"

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

CMD ["node", "dist/index.js"]
